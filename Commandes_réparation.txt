sudo cryptsetup open /dev/vda2 cryptroot


# 1. Monter le sous-volume @nix (le store) et @home sur /mnt
# (Adapte nvme0n1p3 selon le disque de la machine)
sudo mount /dev/mapper/cryptroot /mnt -o subvol=@nix
sudo mount /dev/mapper/cryptroot /mnt/home -o subvol=@home
# Ne pas oublier la partition BOOT
sudo mount /dev/vda1 /mnt/boot

# 2. Recr√©er le root en RAM pour le chroot
sudo mount -t tmpfs none /mnt -o size=2G,mode=755
# Refaire les montages par-dessus (comme dans ton script)
sudo mkdir -p /mnt/{nix,home,boot}
sudo mount /dev/mapper/cryptroot /mnt/nix -o subvol=@nix
sudo mount /dev/mapper/cryptroot /mnt/home -o subvol=@home
sudo mount /dev/vda1 /mnt/boot


sudo nixos-enter --root /mnt


# Le script nixos-enter est un peu "tatillon" : il cherche le fichier /etc/NIXOS (qui est un fichier vide servant de marqueur) pour confirmer que le dossier est bien une racine NixOS. Comme ton dossier /etc est sur un tmpfs qui a √©t√© effac√© au reboot, le marqueur a disparu.
üõ†Ô∏è La solution (Le "Quick Fix")


# 1. Cr√©er le dossier etc s'il n'existe pas dans ton montage tmpfs
sudo mkdir -p /mnt/etc

# 2. Cr√©er le marqueur magique
sudo touch /mnt/etc/NIXOS

# 3. R√©essayer l'entr√©e
sudo nixos-enter --root /mnt

Et enfin :
NIXOS_CONFIG=/home/benoit/Mes-Donnees/Git/nixos-dotfiles/configuration.nix nixos-rebuild boot
