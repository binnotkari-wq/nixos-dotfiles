# 1. Ouvrir le volume LUKS2 (adapter le péripéhrique avec sda, nvme ...)
sudo cryptsetup open /dev/vda2 cryptroot


# 2. Recréer le root en RAM pour le chroot
sudo mount -t tmpfs none /mnt -o size=2G,mode=755
sudo mkdir -p /mnt/{nix,persist,home,boot,swap}
sudo mount /dev/mapper/cryptroot /mnt/nix -o subvol=@nix
sudo mount /dev/mapper/cryptroot /mnt/persist -o subvol=@persist
sudo mount /dev/mapper/cryptroot /mnt/home -o subvol=@home
sudo mount /dev/mapper/cryptroot /mnt/swap -o subvol=@swap
sudo mount /dev/vda1 /mnt/boot


sudo nixos-enter --root /mnt

# 3. Entrer dans l'installation ciblée

# nixos-enter est un peu "tatillon" : il cherche le fichier /etc/NIXOS (qui est un fichier vide servant de marqueur) pour confirmer que le dossier est bien une racine NixOS. Comme ton dossier /etc est sur un tmpfs qui a été effacé au reboot, le marqueur a disparu.

# Solution

# Créer le dossier etc s'il n'existe pas dans ton montage tmpfs
sudo mkdir -p /mnt/etc

# Créer le marqueur magique
sudo touch /mnt/etc/NIXOS

# Entrer
sudo nixos-enter --root /mnt


# 4. Rebuild

# En ayant corrigé les .nix au prélable ...
NIXOS_CONFIG=/home/benoit/Mes-Donnees/Git/nixos-dotfiles/REMPLACER_PAR_LE_NOM_DE_LA_MACHINE.nix nixos-rebuild boot
